name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake libevent-dev golang

      - name: Clone BoringSSL
        run: |
          git clone --depth 1 https://github.com/google/boringssl.git \
            third_party/xquic/third_party/boringssl

      - name: Build BoringSSL
        run: |
          cd third_party/xquic/third_party/boringssl
          mkdir -p build && cd build
          cmake -DBUILD_SHARED_LIBS=0 -DCMAKE_C_FLAGS="-fPIC" -DCMAKE_CXX_FLAGS="-fPIC" ..
          make -j$(nproc) ssl crypto

      - name: Build xquic
        run: |
          cd third_party/xquic
          mkdir -p build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DSSL_TYPE=boringssl \
                -DXQC_ENABLE_BBR2=ON \
                -DCMAKE_C_FLAGS="-Wno-dangling-pointer" ..
          make -j$(nproc)

      - name: Build mqvpn
        run: |
          mkdir -p build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DXQUIC_BUILD_DIR=../third_party/xquic/build ..
          make -j$(nproc)

      - name: Unit tests (ctest)
        run: cd build && ctest --output-on-failure

      - name: Smoke test (netns)
        run: sudo scripts/run_test.sh

      - name: Multi-client test (netns)
        run: sudo scripts/test_multiclient.sh
